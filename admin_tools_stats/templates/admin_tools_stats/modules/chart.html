{% extends "admin_tools/dashboard/module.html" %}
{% load nvd3_tags %}

{% if module.require_chart_jscss %}
    {% load static %}
{% endif %}

{% block module_content %}
    {# Jquery CDN : Needed when using jquery_on_ready=True #}
    {% if module.extra.jquery_on_ready %}
        <script src="{% static "admin_tools/js/jquery/jquery.min.js" %}"></script>
    {% endif %}
    {% if module.require_chart_jscss %}
        <link media="all" href="{% static 'nvd3/src/nv.d3.css' %}" type="text/css" rel="stylesheet" />
        <script src="{% static 'nvd3/lib/d3.v2.js' %}" type="text/javascript"></script>
        <script src="{% static 'nvd3/nv.d3.js'%}" type="text/javascript"></script>
    {% endif %}

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded',function(){
            // Have a good enough sleep, wait for loading jquery and nvd3 files
            function draw_graph() {
                {% load_chart module.chart_type module.values module.chart_container module.extra %}
            }

            function on_loaded() {
                var init_value = true;
                var html_string = '<svg style="width:{{module.chart_width}}%;height:{{module.chart_height}}px;" height="450"></svg>';

                $('a.ui-tabs-anchor[href$={{ module.interval }}_{{ module.graph_key}}]').on('click', function(event) {
                    console.log("{{ module.interval }}_{{ module.graph_key}}")

                    var href_val = event.target.hash;
                    if(href_val.indexOf('{{ module.interval }}_{{ module.graph_key}}' ) != -1)
                    {
                        $('#{{module.chart_container}}').empty().append(html_string);
                        draw_graph();
                    }
                    init_value = false;
                });
                // init
                if(init_value){
                    draw_graph();
                }
            }

            function are_files_loaded() {
                if (typeof(jQuery) == 'undefined' || typeof(nv) == 'undefined')
                    return false;
                else
                    return true;
            }

            function wait_files(on_loaded) {
                if (are_files_loaded()) {
                    on_loaded();
                } else {
                    setTimeout(function() {
                        wait_files(on_loaded)},
                    100);
                }
            }

            function is_module_loaded() {
                return $('a.ui-tabs-anchor').length > 0;
            }

            function wait_module(on_loaded) {
                if (is_module_loaded()) {
                    on_loaded();
                } else {
                    setTimeout(function() {
                        wait_module(on_loaded);
                    }, 100);
                }
            }

            wait_files(function() {
                wait_module(on_loaded);
            });
        });

    </script>

    {% if module.form_field %}
        <form id="stateform" action="." method="POST" enctype="multipart/form-data">{% csrf_token %}
            {{ module.form_field }}
        </form>
        <br/>
    {% endif %}

    {% include_container module.chart_container module.chart_height module.chart_width %}

{% endblock %}

